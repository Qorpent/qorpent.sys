using System;
using System.Linq;
using Qorpent.Mvc.Binding;
using Qorpent.Wiki;

namespace Qorpent.Mvc.Actions {
	/// <summary>
	/// Действие получения страницы Wiki
	/// </summary>
	[Action("wiki.save", Help = "Сохранить правки в страницу", Role = "DOCWRITER")]
	public class WikiSaveAction : WikiActionBase {
		/// <summary>
		/// Код или коды страниц, которые требуется проверить
		/// </summary>
		[Bind(Required = true)]
		public string Code;

		/// <summary>
		/// Заголовок страницы, имя
		/// </summary>
		[Bind]
		public string Title;
		/// <summary>
		/// Новый текст страницы
		/// </summary>
		[Bind] public string Text;

		/// <summary>
		/// Возвращает страницы Wiki по запросу
		/// </summary>
		/// <returns></returns>
		protected override object MainProcess() {
			var page = new WikiPage {Code = Code, Title = Title ?? "",Text = Text ?? ""};
			foreach (var parameter in Context.Parameters) {
				if (
					parameter.Key.ToUpper() != "CODE" 
					&& parameter.Key.ToUpper() != "TEXT"
					&& parameter.Key.ToUpper() != "TITLE"
					) {
					page.Propeties[parameter.Key] = parameter.Value;
				}
			}
			var success = WikiSource.Save(page);

            if (!success) {
                throw new Exception("Вы не имеет прав на редактирование страницы. Страница заблокирована.");
            }

			return WikiSource.Get(null,Code).First();
		}
	}
}